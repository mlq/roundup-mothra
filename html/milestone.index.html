{% extends '_layout/base.html' %}

{% set title = "Milestones" %}

{% block breadcrumb %}
<ul class="breadcrumb">
  <li>
    <a href="/">
      Home
    </a>
  </li>
  {% if request.form.project %}
    {% set project_id = request.form.project.value %}
    {% set project = db.project.getItem(project_id) %}
    <li>
      <a href="project">
        {{ i18n.gettext('Projects') }}
      </a>
    </li>
    <li>
      <a href="project{{ project_id }}">
        {{ project.name }}
      </a>
    </li>
  {% endif %}
  <li class="active">
    {{ title }}
  </li>
</ul>
{% endblock %}

{% block content %}
  {% include '_include/permission.html' %}

  {% if context.is_view_ok() %}
    {% for milestone in request.batch() %}
    <h2>{{ milestone.name }}</h2>

    {% set milestone_issues =
    db.issue.filter(filterspec={"milestone":milestone.id}, sort=[('+', 'status'), ('+', 'creation')]) %}

    {% if milestone_issues|length != 0 %}
      <div class="progress">
        {% set done = utils.project_milestone_get_done(milestone_issues) %}
        {% set progress = utils.project_milestone_get_progress(milestone_issues) %}
        <div class="progress-bar progress-bar-success" style="width: {{ done }}%;"></div>
        <div class="progress-bar progress-bar-warning" style="width: {{ progress }}%;"></div>
        <span class="value">{{ done + progress }}%</span>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>{{ i18n.gettext('ID') }}</th>
            <th>{{ i18n.gettext('Type') }}</th>
            <th>{{ i18n.gettext('Name') }}</th>
          </tr>
        </thead>
        <tbody>
        {% for issue in milestone_issues %}
          {% if issue.status.plain() == "resolved" %}
          <tr class="success">
          {% elif issue.status.plain() == "in-progress" %}
          <tr class="warning">
          {% else %}
          <tr>
          {% endif %}
            <td>
              <a href="issue{{ issue.id }}">
                {{ issue.id }}
              </a>
            </td>
            <td>
              {% if issue.issue_type.plain() == "feature request" %}
                Feature
              {% elif issue.issue_type.plain() == "security" %}
                Security
              {% else %}
                Patch
              {% endif %}
            </td>
            <td>
              <a href="issue{{ issue.id }}">
               {{ issue.title.plain(hyperlink=0) }}
              </a>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
    {% endfor %}
  </ul>
  {% endif %}
{% endblock %}
